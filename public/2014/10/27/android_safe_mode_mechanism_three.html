<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android安全模式机制," />








  <link rel="shortcut icon" type="image/x-icon" href="/icon/1.ico?v=5.0.1" />






<meta name="description" content="h3 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}
h6 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}



目录:

1.移动平台中的主流签名作用

1.1自签名的完整性鉴别
1.2信任模式">
<meta property="og:type" content="article">
<meta property="og:title" content="Android安全模式机制之三(实际运用)">
<meta property="og:url" content="http://comtu.github.com/2014/10/27/android_safe_mode_mechanism_three.html">
<meta property="og:site_name" content="Comtu">
<meta property="og:description" content="h3 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}
h6 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}



目录:

1.移动平台中的主流签名作用

1.1自签名的完整性鉴别
1.2信任模式">
<meta property="og:image" content="http://comtu.github.com/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/001.png">
<meta property="og:image" content="http://comtu.github.com/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/002.png">
<meta property="og:image" content="http://comtu.github.com/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/003.png">
<meta property="og:image" content="http://comtu.github.com/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/004.png">
<meta property="og:image" content="http://comtu.github.com/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/005.png">
<meta property="og:updated_time" content="2016-04-27T07:55:36.279Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android安全模式机制之三(实际运用)">
<meta name="twitter:description" content="h3 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}
h6 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}



目录:

1.移动平台中的主流签名作用

1.1自签名的完整性鉴别
1.2信任模式">
<meta name="twitter:image" content="http://comtu.github.com/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/001.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 9414502,
      author: '博主'
    }
  };
</script>

  <title> Android安全模式机制之三(实际运用) | Comtu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e0d9a75a7e53b54cd1e6649facd5906e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Comtu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android安全模式机制之三(实际运用)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-10-27T00:00:00+08:00" content="2014-10-27">
              2014-10-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/10/27/android_safe_mode_mechanism_three.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="/2014/10/27/android_safe_mode_mechanism_three.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <style>
h3 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}
h6 {
    line-height: 1.5;
    letter-spacing: 2px;
    margin-top: -10px;
}

</style>

<p>目录:</p>
<ul>
<li><p>1.移动平台中的主流签名作用</p>
<ul>
<li>1.1自签名的完整性鉴别</li>
<li>1.2信任模式</li>
<li>1.3限制安装/运行</li>
<li>1.4权限的作用</li>
<li>1.5权限的安全性保护</li>
<li>1.6Android的签名作用</li>
<li>1.7Android APK之METAINF</li>
</ul>
</li>
<li><p>2.Android中的权限</p>
<ul>
<li>2.1Android的权限作用</li>
<li>2.2Android的权限类别</li>
<li>2.3Android的权限定义方式</li>
<li>2.4Android的运行时权限控制方式</li>
<li>2.5Android的Permission与UID/GID的mapping</li>
</ul>
</li>
<li><p>3.Android中的组件的安全机制</p>
<ul>
<li>3.1组件的权限分配(Demo)<ul>
<li>3.1.1 Activity</li>
<li>3.1.2 Service</li>
<li>3.1.3 ContentProvide</li>
<li>3.1.4 BroadcastReceiver</li>
</ul>
</li>
</ul>
</li>
<li><p>4.Android应用安装</p>
<ul>
<li>4.1应用安装的安全性考虑和调用方式</li>
<li>4.2应用安装流程之UID/GID的分配</li>
<li>4.3应用安装流程之工作目录的创建和权限设置</li>
</ul>
</li>
<li><p>5.Android中系统Service的安全</p>
<ul>
<li>5.1Binder的安全</li>
<li>5.2ServiceManager Add Service的安全限制</li>
<li>5.3Zygote的Process Fork</li>
<li>5.4Zygote的Socket安全检查    </li>
</ul>
</li>
<li><p>6.Android中的ContentProvider以及基于URI的安全</p>
<ul>
<li>6.1ContentProvider的作用</li>
<li>6.2权限临时继承的需求</li>
<li>6.3配置ContentProvider允许临时委派权限</li>
<li>6.4基于URI的权限临时委派</li>
</ul>
</li>
<li><p>7.Android的Policy模式和多设备绑定</p>
<ul>
<li>7.1Android的Policy模式</li>
<li>7.2MR2开始的AppOps(安卓4.3开始)</li>
<li>7.3AppOps对开发者的影响</li>
<li>7.4设备绑定</li>
<li>7.5跨设备使用</li>
</ul>
</li>
<li><p>8.应用内计费和App2SDCard</p>
<ul>
<li>8.1应用内计费</li>
<li>8.2SD卡安装应用的安全策略</li>
</ul>
</li>
<li><p>9.Android中的多用户安全</p>
<ul>
<li>9.1需求场景</li>
<li>9.2UserManagerService</li>
<li>9.3对开发者的影响</li>
</ul>
</li>
<li><p>10.Android Superuser机制讲解</p>
<ul>
<li>10.1ROOT的作用</li>
<li>10.2ROOT的第一步:寻找漏洞并安装特权文件</li>
<li>10.3SU的sUID的特性</li>
<li>10.4SU的核心代码分析</li>
<li>10.5MR2后的方案:SU Deamon Service</li>
</ul>
</li>
<li><p>11.SEAndroid</p>
<ul>
<li>11.1DAC和MAC</li>
<li>11.2基于Label的MAC</li>
<li>11.3推荐读物</li>
</ul>
</li>
</ul>
<a id="more"></a>
<hr>
<h1 id="1-移动平台中的主流签名作用"><a href="#1-移动平台中的主流签名作用" class="headerlink" title="1.移动平台中的主流签名作用"></a>1.移动平台中的主流签名作用</h1><h2 id="1-1-自签名的完整性鉴别"><a href="#1-1-自签名的完整性鉴别" class="headerlink" title="1.1 自签名的完整性鉴别"></a>1.1 自签名的完整性鉴别</h2><pre><code>证书的签名者和证书拥有者是同一个实体---自签名
    作为信任链的根证书.
    完整性鉴别
</code></pre><h2 id="1-2-信任模式"><a href="#1-2-信任模式" class="headerlink" title="1.2 信任模式"></a>1.2 信任模式</h2><pre><code>签名了?
签名是可信的?
可信任和普通应用的权利差异
    人为的把一些操作归类
    某类操作对于可信任应用和普通应用的表现不一样.
</code></pre><h2 id="1-3-限制安装-运行"><a href="#1-3-限制安装-运行" class="headerlink" title="1.3 限制安装/运行"></a>1.3 限制安装/运行</h2><pre><code>应用安装时
    是否包含签名?--&gt;没有?禁止安装
    提取证书进行验证--&gt;证书是有效且可信任的吗?--&gt;不是?禁止安装
    基于证书的公钥对签名进行验证--&gt;签名正确吗?--&gt;不正确?禁止安装
应用运行时
    是否包含签名?--&gt;没有?禁止运行
    提取证书进行验证--&gt;证书是有效且可信任的吗?--&gt;不是?禁止运行
    基于证书的公钥对签名进行验证--&gt;签名正确吗?--&gt;不正确?禁止运行
</code></pre><h2 id="1-4-权限的作用"><a href="#1-4-权限的作用" class="headerlink" title="1.4 权限的作用"></a>1.4 权限的作用</h2><pre><code>细粒度的特权管理
    权限是一个ID或者一个字符串
    权限用来细分权利(类似Capability)
    通常一个权限与一类操作绑定
    权限首先需要申请
    但申请后是否被批准由平台策略决定
</code></pre><h2 id="1-5-权限的安全性保护"><a href="#1-5-权限的安全性保护" class="headerlink" title="1.5 权限的安全性保护"></a>1.5 权限的安全性保护</h2><pre><code>通过签名
    权限的完整性保护:防篡改
    权限的授权安全策略:防Escalate
</code></pre><h2 id="1-6-Android的签名作用"><a href="#1-6-Android的签名作用" class="headerlink" title="1.6 Android的签名作用"></a>1.6 Android的签名作用</h2><h3 id="1-6-1-完整性鉴别"><a href="#1-6-1-完整性鉴别" class="headerlink" title="1.6.1.完整性鉴别"></a>1.6.1.完整性鉴别</h3><pre><code>支持自签名用于完整性鉴别
不做信任模式
不做安装和运行时的限制
</code></pre><h3 id="1-6-2-Signature-Permision和ShareUID"><a href="#1-6-2-Signature-Permision和ShareUID" class="headerlink" title="1.6.2.Signature Permision和ShareUID"></a>1.6.2.Signature Permision和ShareUID</h3><pre><code>Signature Protection Level Permision
    用于特权Permission
    只有特定签名的Apk才被授权

        例如:
</code></pre><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--访问硬件辅助设备,用于硬件测试 --&gt;</span><br><span class="line">&lt;--allows access to hardware peripherals . Intended only for hardware testing . &lt;p&gt;Not for use by third-party applications.--&gt;</span><br><span class="line">&lt;permission android:name="android.permission.HARDWARE_TEST"</span><br><span class="line">	android:permissionGroup="android.permission-group.HARDWARE_CONTROLS"</span><br><span class="line">	android:protectionLevel="signature"</span><br><span class="line">	android:lable="@string/permlab_hardware_test"</span><br><span class="line">	android:description="@string/permadesc_hardware_test" /&gt;</span><br></pre></td></tr></table></figure>
<pre><code>Share Process UID
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:sharedUserId="xxxx"</span><br></pre></td></tr></table></figure>
<pre><code>Process间Share UID的目的是共享资源等 (如:/data/data/A包名/目录下面)
Android中两个APK Share相同的UID必须其签名所用的Private Key一样.
</code></pre><h3 id="1-6-3-身份ID和升级的匹配"><a href="#1-6-3-身份ID和升级的匹配" class="headerlink" title="1.6.3.身份ID和升级的匹配"></a>1.6.3.身份ID和升级的匹配</h3><pre><code>Android中的自签名只是代表了身份,但不代表身份是否可信任
Android的应用的标识符是Package Name
    Package Name不一样,相互不影响,允许同时存在(安装)
    Package Name一样,只能存在一个,允许做升级处理.
升级的安全性考虑
    必须签名的证书一致(防假冒,防侵入隐私)
    如果不一致,则用户要么放弃新的应用,要么先卸载旧的,再安装新的.但这属于安装,不属于升级
    正常的升级将不擦除应用的工作目录数据,以保证历史数据的持续性.
</code></pre><h2 id="1-7Android-APK之METAINF"><a href="#1-7Android-APK之METAINF" class="headerlink" title="1.7Android APK之METAINF"></a>1.7Android APK之METAINF</h2><pre><code>APK结构
</code></pre><p><img src="/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/001.png" alt="apk结构"></p>
<pre><code>META INF的组成
</code></pre><p><img src="/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/002.png" alt="METAINF结构"></p>
<pre><code>签名流程
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar signapk.jar testkey.x509.pem testkey.pk8 update.apk update-signed.apk</span><br></pre></td></tr></table></figure>
<pre><code>    这条命令的意思是:通过signapk.jar这个可执行jar包，以“testkey.x509.pem”这个公钥文件
             和“testkey.pk8”这个私钥文件对“update.apk”进行签名，签名后的文件保存为“update_signed.apk”
    详情可阅:[Android APK 签名比对](http://www.blogjava.net/zh-weir/archive/2011/07/19/354663.html)

MANIFEST.MF文件 (第一重保护,本文本里面包含apk的资源文件的每个文件的SHA1值)
</code></pre><p><img src="/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/003.png" alt="METAINF结构"></p>
<pre><code>CERT.SF文件 (第二重保护,本文本里面包含MANIFEST.MF里的所有内容,并包含有MANIFEST.MF的SHA1-Digest-Manifest)
</code></pre><p><img src="/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/004.png" alt="METAINF结构"></p>
<pre><code>CERT.RSA (第三重保护,此文件是一个PKCS#7格式的文件,
    里面包含证书信息,以及基于私钥的签名信息,
    签名信息是由整个CERT.SF文件的做一个基于sha1(160bit)+rsa(testkey.pk8,publicKey)生成)
</code></pre><p><img src="/res/img/blog/2014/10/27/android_safe_mode_mechanism_three/005.png" alt="METAINF结构"></p>
<hr>
<h1 id="2-Android中的权限"><a href="#2-Android中的权限" class="headerlink" title="2.Android中的权限"></a>2.Android中的权限</h1><h2 id="2-1-Android的权限作用"><a href="#2-1-Android的权限作用" class="headerlink" title="2.1 Android的权限作用"></a>2.1 Android的权限作用</h2><pre><code>细粒度特权管理
    权限与操作关联
    应用需要显式申请权限
    用户对权限可知(不可控) (也可通过LBE,腾讯管家,360等可进行权限控制)
    对特权权限单独控制
</code></pre><h2 id="2-2-Android的权限类别"><a href="#2-2-Android的权限类别" class="headerlink" title="2.2 Android的权限类别"></a>2.2 Android的权限类别</h2><pre><code>Normal 没那么敏感
Dangerous 比较敏感的,安装时会被列举出来.
Signature 基于特殊权限的权限(申请权限的apk它的签名的私钥必须要跟定义这个权限的私钥一致)
SignatureOrSystem  申请权限的apk它的签名的私钥必须要跟定义这个权限的私钥一致或者apk是系统应用
</code></pre><h2 id="2-3-Android的权限定义方式"><a href="#2-3-Android的权限定义方式" class="headerlink" title="2.3 Android的权限定义方式"></a>2.3 Android的权限定义方式</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Allows an application to monitor incoming SMS messages, to record or perform processing on them. --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.RECEIVE_SMS"</span></span><br><span class="line">	<span class="attr">android:permissionGroup</span>=<span class="string">"android.permission-group.MESSAGES"</span></span><br><span class="line">	<span class="attr">android:protectionLevel</span>=<span class="string">"dangerous"</span></span><br><span class="line">	<span class="attr">android:label</span>=<span class="string">"@string/permlab_receiveSms"</span></span><br><span class="line">	<span class="attr">android:description</span>=<span class="string">"@string/permdesc_receiveSms"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!--name 权限名称</span><br><span class="line">	permissionGroup 权限组</span><br><span class="line">	protectionLevel 权限类别</span><br><span class="line">	label 安装时用户可查看到的信息,提示申请当前权限的作用</span><br><span class="line">	description 显示给用户的申请权限的详细概述--&gt;</span></span><br></pre></td></tr></table></figure>
<p><a href="http://osdn.jp/projects/gb-231r1-is01/scm/git/Gingerbread_2.3.3_r1_IS01/blobs/master/frameworks/base/core/res/AndroidManifest.xml" target="_blank" rel="external">源代码frameworks/base/core/res/AndroidManifest.xml</a></p>
<h2 id="2-4-Android的运行时权限控制方式"><a href="#2-4-Android的运行时权限控制方式" class="headerlink" title="2.4 Android的运行时权限控制方式"></a>2.4 Android的运行时权限控制方式</h2><pre><code>通过PM的CheckPermission
    Android独有的Service(底层平台不具有)
    所以需要在Android本身Framework中控制
    主流的Service一般都基于Binder IPC或者其他IPC提供服务
    所以在最底层控制(Service所在的Server中)以避免逃逸控制
        绕开应用函数直接调用远程服务
    例子:(mContext.checkCallingOrSelfPermission(permission) == PackageManager.PERMISSION_GRANTED)

映射为OS的特定属性
    非Android特有的Service(底层平台已经提供,如File访问,TCPIP数据收发等)
    多个入口访问ndroidAPI,Java API NDK C API , Shell , et:Ac
    底层控制准则,会聚口在底层,所以在底层(OS层面)统一控制,这样可以避免逃逸控制
    所以复用OS的一些安全控制特性,比如GID
    所以需要把Android空间的Permission Mapping到OS的GID
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">进入到手机SDCard里发现GID都是sdcard_rw</span><br><span class="line">shell@android:/storage/sdcard0 $ ls -l</span><br><span class="line">ls -l</span><br><span class="line">	      UID      GID</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2014-12-15 18:03 Android</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2015-03-18 16:09 BaiduMapSdk</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2014-06-30 10:04 BaoDownload</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2014-07-07 17:33 Cache</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2014-12-15 18:03 CloudDrive</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2015-03-20 11:33 DCIM</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2014-12-15 18:02 Download</span><br><span class="line">drwxrwxr-x system   sdcard_rw          2015-03-04 12:05 ExtDataTunnel</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span></span><br><span class="line"><span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--当开发者增加上条权限时会程序会自动增加这条信息. 本信息来源:frameworks/base/data/etc/platform.xml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"sdcard_rw"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/*进程所占内存proc pid status*/</span><br><span class="line">shell@android:/proc/5914 # cat status</span><br><span class="line">cat status</span><br><span class="line">Name:   n.ledinside.app /*进程的程序名*/</span><br><span class="line">State:  S (sleeping) /*进程的状态信息*/</span><br><span class="line">Tgid:   5914 /*线程组号*/</span><br><span class="line">Pid:    5914 /*进程pid*/</span><br><span class="line">PPid:   148 /*父进程的pid*/</span><br><span class="line">TracerPid:      0 /*跟踪进程的pid*/</span><br><span class="line">Uid:    10075   10075   10075   10075 /*uid euid suid fsuid*/</span><br><span class="line">Gid:    10075   10075   10075   10075 /*gid egid sgid fsgid*/</span><br><span class="line">FDSize: 256 /*文件描述符的最大个数，file-&gt;fds*/</span><br><span class="line">Groups: 1015 1028 3003/*启动该进程的用户所属的组的id*/</span><br><span class="line">VmPeak:   354256 kB /*进程地址空间的大小*/</span><br><span class="line">VmSize:   301964 kB /*进程虚拟地址空间的大小reserved_vm：进程在预留或特殊的内存间的物理页*/</span><br><span class="line">VmLck:         0 kB /*进程已经锁住的物理内存的大小.锁住的物理内存不能交换到硬盘*/</span><br><span class="line">VmPin:         0 kB</span><br><span class="line">VmHWM:     63052 kB /*文件内存映射和匿名内存映射的大小*/</span><br><span class="line">VmRSS:     33884 kB /*应用程序正在使用的物理内存的大小，就是用ps命令的参数rss的值 (rss)*/</span><br><span class="line">VmData:    30484 kB /*程序数据段的大小（所占虚拟内存的大小），存放初始化了的数据*/</span><br><span class="line">VmStk:       136 kB /*进程在用户态的栈的大小*/</span><br><span class="line">VmExe:         8 kB /*程序所拥有的可执行虚拟内存的大小,代码段,不包括任务使用的库 */</span><br><span class="line">VmLib:     28068 kB /*被映像到任务的虚拟内存空间的库的大小*/</span><br><span class="line">VmPTE:       150 kB /*该进程的所有页表的大小*/</span><br><span class="line">VmSwap:        0 kB</span><br><span class="line">Threads:        15 /*共享使用该信号描述符的任务的个数*/</span><br><span class="line">SigQ:   0/3133 /*待处理信号的个数/目前最大可以处理的信号的个数*/</span><br><span class="line">SigPnd: 0000000000000000 /*屏蔽位，存储了该线程的待处理信号*/</span><br><span class="line">ShdPnd: 0000000000000000 /*屏蔽位，存储了该线程组的待处理信号*/</span><br><span class="line">SigBlk: 0000000000001204 /*存放被阻塞的信号*/</span><br><span class="line">SigIgn: 0000000000000000 /*存放被忽略的信号*/</span><br><span class="line">SigCgt: 00000002000094e8 /*存放被俘获到的信号*/</span><br><span class="line">CapInh: 0000000000000000 /*能被当前进程执行的程序的继承的能力*/</span><br><span class="line">CapPrm: 0000000000000000 /*进程能够使用的能力，可以包含CapEff中没有的能力，这些能力是被进程自己临时放弃的*/</span><br><span class="line">CapEff: 0000000000000000 /*是CapPrm的一个子集，进程放弃没有必要的能力有利于提高安全性*/</span><br><span class="line">CapBnd: ffffffffffffffff</span><br><span class="line">Cpus_allowed:   3 /*可以执行该进程的CPU掩码集*/</span><br><span class="line">Cpus_allowed_list:      0-1</span><br><span class="line">voluntary_ctxt_switches:        223 /*进程主动切换的次数*/</span><br><span class="line">nonvoluntary_ctxt_switches:     406 /*进程被动切换的次数*/</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Groups中1015正好对应的是SDCARD_RW--&gt;</span></span><br><span class="line">#define AID_MEDIA         1013  /* mediaserver process */</span><br><span class="line">#define AID_DHCP          1014  /* dhcp client */</span><br><span class="line">#define AID_SDCARD_RW     1015  /* external storage write access */</span><br><span class="line">#define AID_VPN           1016  /* vpn system */</span><br><span class="line">#define AID_KEYSTORE      1017  /* keystore subsystem */</span><br><span class="line">#define AID_USB           1018  /* USB devices */</span><br></pre></td></tr></table></figure>
<h2 id="2-5-Android的Permission与UID-GID的mapping"><a href="#2-5-Android的Permission与UID-GID的mapping" class="headerlink" title="2.5 Android的Permission与UID/GID的mapping"></a>2.5 Android的Permission与UID/GID的mapping</h2><pre><code>语法:
    UID assigning permission: 
        &lt; assign-permission name=&quot;permission_name&quot; uid=&quot;target_uid&quot; /&gt;
    GIDs Mapping:
        &lt;permission name=&quot;permission_nema&quot; &gt;
        &lt;group gid=&quot;assigned gid&quot; /&gt;
        &lt;group gid=&quot;assigned gid&quot; /&gt;
        .....
        &lt;/permission&gt;
发生时刻:安装时
etc/permissions
    任何符合以上语法的在system/etc/permissions下面的xml文件,都会被系统读取来parse并进行UID/GID的mapping.
    比如Platform.xml(check代码)
</code></pre><p><a href="http://osdn.jp/projects/gb-231r1-is01/scm/git/Gingerbread_2.3.3_r1_IS01/blobs/master/frameworks/base/data/etc/platform.xml" target="_blank" rel="external">frameworks/base/data/etc/platform.xml</a></p>
<pre><code>安全性
    任何应用都可以为自己的permission assign GID? 
        当然不行! 只有Root用户才允许新增或者改写.
        并且对于ROOT用户组的用户也只有r权限
        如下为手机system/etc/permissions目录下的文件权限
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">shell@android:/system/etc # ls -l	</span><br><span class="line">....</span><br><span class="line">drwxr-xr-x root     root              2013-07-09 21:54 permissions</span><br><span class="line">....</span><br><span class="line">shell@android:/system/etc # cd permissions</span><br><span class="line">shell@android:/system/etc/permissions # ls -l platform.xml</span><br><span class="line">-rw-r--r-- root     root         9466 2008-08-01 20:00 platform.xml</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="3-Android中的组件的安全机制"><a href="#3-Android中的组件的安全机制" class="headerlink" title="3.Android中的组件的安全机制"></a>3.Android中的组件的安全机制</h1><pre><code>Android的4大组件及组件间的通信
组件的public和private
组件的权限分配
</code></pre><h2 id="3-1-组件的权限分配-demo"><a href="#3-1-组件的权限分配-demo" class="headerlink" title="3.1 组件的权限分配(demo)"></a>3.1 组件的权限分配(demo)</h2><h3 id="3-1-1-Activity"><a href="#3-1-1-Activity" class="headerlink" title="3.1.1.Activity"></a>3.1.1.Activity</h3><pre><code>服务端增加相应的权限:
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attr">package</span>=<span class="string">"com.tu.test.diyPermission"</span></span><br><span class="line">    <span class="attr">android:versionCode</span>=<span class="string">"1"</span></span><br><span class="line">    <span class="attr">android:versionName</span>=<span class="string">"1.0"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span></span><br><span class="line">	<span class="attr">android:minSdkVersion</span>=<span class="string">"8"</span></span><br><span class="line">	<span class="attr">android:targetSdkVersion</span>=<span class="string">"19"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 自定义Activity权限 start --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 自定义Activity权限 end --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span><br><span class="line">	<span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span><br><span class="line">	<span class="attr">android:icon</span>=<span class="string">"@drawable/ic_launcher"</span></span><br><span class="line">	<span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> &gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">activity</span></span><br><span class="line">	    <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.MainActivity"</span></span><br><span class="line">	    <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> &gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 自定义Activity权限 start --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">activity</span></span><br><span class="line">	    <span class="attr">android:name</span>=<span class="string">".NewPageActivity"</span></span><br><span class="line">	    <span class="attr">android:exported</span>=<span class="string">"true"</span></span><br><span class="line">	    <span class="attr">android:permission</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION"</span> &gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.NewPageActivity"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 自定义Activity权限 end --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>客户端必须申请许可:
否则会抛出:

    java.lang.SecurityException: Permission Denial: starting Intent { 
        act=com.tu.test.diyPermission.NewPageActivity cmp=com.tu.test.
        diyPermission/.NewPageActivity (has extras) } from ProcessRecord
        {41efe3e8 8642:com.tu.test.diyPermission.client/u0a204} (pid=8642,
        uid=10204) requires com.tu.test.diyPermission.DIYPERMISSION
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attr">package</span>=<span class="string">"com.tu.test.diyPermission.client"</span></span><br><span class="line">    <span class="attr">android:versionCode</span>=<span class="string">"1"</span></span><br><span class="line">    <span class="attr">android:versionName</span>=<span class="string">"1.0"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span></span><br><span class="line">	<span class="attr">android:minSdkVersion</span>=<span class="string">"8"</span></span><br><span class="line">	<span class="attr">android:targetSdkVersion</span>=<span class="string">"19"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 申请应用DiyPermission中的自定义Activity权限 start --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 申请应用DiyPermission中的自定义Activity权限 end --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span><br><span class="line">	<span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span><br><span class="line">	<span class="attr">android:icon</span>=<span class="string">"@drawable/ic_launcher"</span></span><br><span class="line">	<span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> &gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">activity</span></span><br><span class="line">	    <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.client.MainActivity"</span></span><br><span class="line">	    <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span> &gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-service"><a href="#3-1-2-service" class="headerlink" title="3.1.2.service"></a>3.1.2.service</h3><pre><code>服务端增加相应的权限:
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span></span><br><span class="line">	<span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_SERVICE"</span></span><br><span class="line">	<span class="attr">android:label</span>=<span class="string">"diy Permission service"</span> </span><br><span class="line">	<span class="attr">android:description</span>=<span class="string">"@string/hello_world"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">	 <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">		....</span><br><span class="line">		 <span class="tag">&lt;<span class="name">service</span></span><br><span class="line">		    <span class="attr">android:name</span>=<span class="string">".service.NewService"</span></span><br><span class="line">		    <span class="attr">android:enabled</span>=<span class="string">"true"</span></span><br><span class="line">		    <span class="attr">android:exported</span>=<span class="string">"true"</span></span><br><span class="line">		    <span class="attr">android:permission</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_SERVICE"</span> &gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.SERVICE_ACTION"</span> /&gt;</span></span><br><span class="line">		    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line">	 <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>客户端必须申请许可:
否则会抛出:
    Caused by: java.lang.SecurityException: 
        Not allowed to bind to service Intent { act=com.tu.test.diyPermission.SERVICE_ACTION }
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_SERVICE"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-1-3-ContentProvide"><a href="#3-1-3-ContentProvide" class="headerlink" title="3.1.3.ContentProvide"></a>3.1.3.ContentProvide</h3><pre><code>服务端增加相应的权限:
    读,写,访问权限.
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_WRITE"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_READ"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	 <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">		....</span><br><span class="line">		 <span class="tag">&lt;<span class="name">provider</span></span><br><span class="line">		    <span class="attr">android:name</span>=<span class="string">".provider.NewContentProvider"</span></span><br><span class="line">		    <span class="attr">android:exported</span>=<span class="string">"true"</span></span><br><span class="line">		    <span class="attr">android:authorities</span>=<span class="string">"com.tu.test.diyPermission.providers.PersonProvider"</span></span><br><span class="line">		    <span class="attr">android:readPermission</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_READ"</span></span><br><span class="line">		    <span class="attr">android:writePermission</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_WRITE"</span></span><br><span class="line">		    <span class="attr">android:permission</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER"</span> /&gt;</span></span><br><span class="line">	 <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>客户端必须申请许可:
否则会抛出:
    Caused by: java.lang.SecurityException: Permission Denial: opening provider 
    com.tu.test.diyPermission.provider.NewContentProvider from ProcessRecord{4236abd0
    22086:com.tu.test.diyPermission.client/u0a204} (pid=22086, uid=10204) requires 
    com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_READ or com.tu.test.
    diyPermission.DIYPERMISSION_CONTENTPROVIDER_WRITE
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_WRITE"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_READ"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-1-4-BroadcastReceiver"><a href="#3-1-4-BroadcastReceiver" class="headerlink" title="3.1.4.BroadcastReceiver"></a>3.1.4.BroadcastReceiver</h3><pre><code>服务端增加权限:
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">	....</span><br><span class="line">	 <span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.BROADCESTRECEIVER"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">		....</span><br><span class="line">	  <span class="tag">&lt;<span class="name">receiver</span></span><br><span class="line">	    <span class="attr">android:name</span>=<span class="string">".receiver.NewReceiver"</span></span><br><span class="line">	    <span class="attr">android:permission</span>=<span class="string">"com.tu.test.diyPermission.BROADCESTRECEIVER"</span> &gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.BROADCESTRECEIVER_ACTION"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>客户端必须申请许可:
    否则服务端周日接收不到信息
</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"com.tu.test.diyPermission.BROADCESTRECEIVER"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="4-应用安装"><a href="#4-应用安装" class="headerlink" title="4.应用安装"></a>4.应用安装</h1><h2 id="4-1-应用安装的安全性考虑和调用方式"><a href="#4-1-应用安装的安全性考虑和调用方式" class="headerlink" title="4.1.应用安装的安全性考虑和调用方式"></a>4.1.应用安装的安全性考虑和调用方式</h2><pre><code>应用安装是一个高特权/风险操作,所以必须是可知/可控,主流实现方式:客户只能委派而不能直接操作.
调用安装传统模式: 发送Intent给系统的Package Install app
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">intent.setAction(Intent.ACTION_VIEW);</span><br><span class="line">intent.setDataAndType(Uri.fromFile(file), <span class="string">"application/vnd.android.package-archive"</span>);</span><br><span class="line">intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<pre><code>特权安装模式:系统的Package Install App内部会调用PackageManagerService的Install Package,
    该操作与android.permission.INSTALL_PACKAGES 绑定,且该peimission的protection level是 signature|system

所谓的静默安装方式只存在Root手机上,开发者可以选择:
    基于pm cmd : pm install -r
</code></pre><h2 id="4-2-应用安装流程之UID-GID的分配"><a href="#4-2-应用安装流程之UID-GID的分配" class="headerlink" title="4.2.应用安装流程之UID/GID的分配"></a>4.2.应用安装流程之UID/GID的分配</h2><pre><code>基于Android4.3原代码目录
frameworks/base/services/java/com/android/srver/pm/PackageManagerService.java
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//installPackage 将会调用 scanPackageLI</span></span><br><span class="line"></span><br><span class="line">privage PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg,<span class="keyword">int</span> parseFlags,<span class="keyword">int</span> scanMode,log currentTime,UserHandle user)</span></span>&#123;</span><br><span class="line">	....</span><br><span class="line">	pkgSetting = mSettings.getPackageLPw(pkg,origPackage,realName,suid,destCodeFile,destResourceFile,pkg.applicationInfo.nativeLibraryDir,pkg.applicationInfo.flags,user,<span class="keyword">false</span>);</span><br><span class="line">	.....</span><br><span class="line">	pkg.applicationInfo.uid = pkgSetting.appId;<span class="comment">//说明是由Settings里面产生Uid,获取到appId</span></span><br><span class="line">	....</span><br><span class="line">	<span class="comment">//invoke installer to do the actual installation </span></span><br><span class="line">	<span class="keyword">int</span> ret = createDataDirsLI(pagName,pkg.applicationInfo.uid,pkg.applicationInfo.seinfo);<span class="comment">//创建工作目录和权限设置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>fameworks/base/services/java/com/android/server/pm/Settings.java
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageSetting <span class="title">getPackageLPw</span><span class="params">(String name,PackageSetting origPackage,String realName,SharedUserSetting shardUser,File codePath,File resourcePath,String nativeLibraryPathString,<span class="keyword">int</span> vc,<span class="keyword">int</span> pkgFlags,UserHandle installUser,Boolean add , <span class="keyword">boolean</span> allowlnstall)</span></span>&#123;</span><br><span class="line">	PackageSetting p = mPackages.get(name);</span><br><span class="line">	<span class="keyword">if</span>(p!=<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(!p.codePath.equals(codePath))&#123;</span><br><span class="line">			<span class="comment">//check to see if its a disabled syste</span></span><br><span class="line">			.....</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="comment">//Assign new user id</span></span><br><span class="line">			p.appId = newUserIdLPw(p);<span class="comment">//分配Uid</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分配Uid的方法</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">newUserIdLPw</span><span class="params">(Object obj)</span></span>&#123;</span><br><span class="line">	<span class="comment">//Let's be stupidly inefficient for now...</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;N;i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(mUserIds.get(i)==<span class="keyword">null</span>)&#123;</span><br><span class="line">			mUserIds.set(i,obj);</span><br><span class="line">			<span class="keyword">return</span> Process.FIRST_APPLICATION_UID + i;<span class="comment">//这就为什么用户安装的uid都是大于10000的原因.</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//None left?</span></span><br><span class="line">	<span class="keyword">if</span>(N&gt;(Process.LAST_APPLICATION_UID-Process.FIRST_APPLICATION_UID))&#123;</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	mUserIds.add(obj);</span><br><span class="line">	<span class="keyword">return</span> Process.FIRST_APPLICATION_UID+N;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/os/Process.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIRST_APPLICATION_UID=<span class="number">10000</span>;<span class="comment">//这就为什么用户安装的uid都是大于10000的原因.</span></span><br></pre></td></tr></table></figure>
<h2 id="4-3-应用安装流程之工作目录的创建和权限设置"><a href="#4-3-应用安装流程之工作目录的创建和权限设置" class="headerlink" title="4.3.应用安装流程之工作目录的创建和权限设置"></a>4.3.应用安装流程之工作目录的创建和权限设置</h2><pre><code>frameworks/base/services/java/com/android/server/pm/PackageManagerService.java
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createDataDirsLI</span><span class="params">(String packageName,<span class="keyword">int</span> uid,String seinfo)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> [] users = sUserManager.getUserIds();</span><br><span class="line">	<span class="keyword">int</span> res = mlnstaller.install(packageName,uid,uid,seinfo);<span class="comment">//从这里可以看出uid gid都被设置成uid</span></span><br><span class="line">	<span class="keyword">if</span>(res&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//only for multi-user//Android 4.1之后支持多用户</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> user: users)&#123;</span><br><span class="line">		<span class="keyword">if</span>(user!=<span class="number">0</span>)&#123;</span><br><span class="line">			res = mlnstaller.createUserData(packageName,UserHandle.getUid(user,uid),user);</span><br><span class="line">			<span class="keyword">if</span>(res&lt;<span class="number">0</span>)&#123;</span><br><span class="line">				<span class="keyword">return</span> res;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>frameworks/base/services/java/com/anddroid/server/pm/Installer.java
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">connect</span><span class="params">()</span></span>&#123;<span class="comment">//Installer一起来会进行初始化</span></span><br><span class="line">	<span class="keyword">if</span>(mSocket!=<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		mSocket = <span class="keyword">new</span> LocalSocket();</span><br><span class="line">		<span class="comment">//本地Socket</span></span><br><span class="line">		LocalSocketAddress address = <span class="keyword">new</span> LocalSocketAddress(<span class="string">"installd"</span>,LocalSocketAddress.Namespace.RESERVED);</span><br><span class="line">		mSocket.connect(address);</span><br><span class="line">		mIn = mSocket.getInputStream();</span><br><span class="line">		mOut = mSocket.getOutputStream();</span><br><span class="line">	&#125;<span class="keyword">catch</span>(IOException ex)&#123;</span><br><span class="line">		disconnect();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">install</span><span class="params">(String name,<span class="keyword">int</span> uid , <span class="keyword">int</span> gid , String seinfo)</span></span>&#123;</span><br><span class="line">	<span class="comment">//内部协议</span></span><br><span class="line">	StringBuilder builder = <span class="keyword">new</span> StringBuilder(<span class="string">"install"</span>);</span><br><span class="line">	builder.append(<span class="string">''</span>);</span><br><span class="line">	builder.append(name);</span><br><span class="line">	builder.append(<span class="string">''</span>);</span><br><span class="line">	builder.append(uid);</span><br><span class="line">	builder.append(<span class="string">''</span>);</span><br><span class="line">	builder.append(gid);</span><br><span class="line">	builder.append(<span class="string">''</span>);</span><br><span class="line">	builder.append(seinfo!=<span class="keyword">null</span>?seinfo:<span class="string">"!"</span>);</span><br><span class="line">	<span class="keyword">return</span> execute(builder.toString());<span class="comment">//会调用mOut mIn发数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>frameworks/native/cmds/installd/installd.c
</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span> </span>&#123;   <span class="comment">//here the SOCKET_PATH is installd</span></span><br><span class="line">	..........</span><br><span class="line">	lsocket = android_get_control_socket(SOCKET_PATH);</span><br><span class="line">	<span class="keyword">if</span> (listen(lsocket, <span class="number">5</span>)) &#123;&#125;</span><br><span class="line">	 fcntl(lsocket, F_SETFD, FD_CLOEXEC);</span><br><span class="line">	 <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		alen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">		s = accept(lsocket, &amp;addr, &amp;alen);</span><br><span class="line">		fcntl(s, F_SETFD, FD_CLOEXEC);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(readx(s,buf,count))&#123;&#125;</span><br><span class="line">		<span class="keyword">if</span>(execute(s,buf))<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_install</span><span class="params">(<span class="keyword">char</span> **arg, <span class="keyword">char</span> reply[REPLY_MAX])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    return install(arg[<span class="number">0</span>], atoi(arg[<span class="number">1</span>]), atoi(arg[<span class="number">2</span>]), atoi(arg[<span class="number">3</span>])); <span class="comment">/* pkgname, uid, gid */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>framework/native/cmds/installd/commands.c
</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">install</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pkgname, <span class="keyword">int</span> encrypted_fs_flag, uid_t uid, gid_t gid)</span></span>&#123;</span><br><span class="line">	.....</span><br><span class="line">	<span class="keyword">if</span>(create_pkg_path(pkgdir,pkgname,PKG_DIR_POSTEIX,<span class="number">0</span>))&#123;<span class="comment">//创建工作目录结构,/data/data/包名/</span></span><br><span class="line">		ALOGE(<span class="string">"cannot create package path\n"</span>);</span><br><span class="line">		return <span class="number">-1</span>;</span><br><span class="line">	&#125;....</span><br><span class="line">	<span class="keyword">if</span> (mkdir(pkgdir, <span class="number">0751</span>) &lt; <span class="number">0</span>) &#123;<span class="comment">//创建目录,并设置权限 0751 uid7(4+2+1)读写执行,gid5(4+1)读执行,其它1(1)执行</span></span><br><span class="line">		ALOGE(<span class="string">"cannot create dir '%s': %s\n"</span>, pkgdir, strerror(errno));</span><br><span class="line">		return <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (chmod(pkgdir,<span class="number">0751</span>) &lt; <span class="number">0</span>) &#123;<span class="comment">//再设置一次权限</span></span><br><span class="line">		ALOGE(<span class="string">"cannot chmod dir '%s': %s\n"</span>, pkgdir, strerror(errno));</span><br><span class="line">		unlink(pkgdir);</span><br><span class="line">		return -errno;</span><br><span class="line">	&#125;.....</span><br><span class="line">	<span class="keyword">if</span>(chown(pkgdir,uid,gid)&lt;<span class="number">0</span>)&#123;<span class="comment">//因设置权限时是使用root用户,些处再进行权限修改.把uid root , gid root 修改成应用的uid,与gid.</span></span><br><span class="line">	.....</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-Android中系统Service的安全"><a href="#5-Android中系统Service的安全" class="headerlink" title="5.Android中系统Service的安全"></a>5.Android中系统Service的安全</h1><h2 id="5-1-Binder的安全"><a href="#5-1-Binder的安全" class="headerlink" title="5.1 Binder的安全"></a>5.1 Binder的安全</h2><pre><code>Binder的作用:实现以IPC的RPC,完成远程业务范围.
</code></pre><p><a href="http://blog.csdn.net/luoshengyang/article/details/6618363" target="_blank" rel="external">Android进程间通信（IPC）机制Binder简要介绍和学习计划</a></p>
<p><a href="http://blog.csdn.net/luoshengyang/article/details/38326729" target="_blank" rel="external">SEAndroid安全机制对Binder IPC的保护分析</a></p>
<h2 id="5-2-ServiceManager-Add-Service的安全限制"><a href="#5-2-ServiceManager-Add-Service的安全限制" class="headerlink" title="5.2 ServiceManager Add Service的安全限制"></a>5.2 ServiceManager Add Service的安全限制</h2><pre><code>Service Manager Process的作用: Naming Resolver,用于RPC框架中 AddService  GetSetvice
</code></pre><h2 id="5-3-Zygote的Process-Fork"><a href="#5-3-Zygote的Process-Fork" class="headerlink" title="5.3 Zygote的Process Fork"></a>5.3 Zygote的Process Fork</h2><p><a href="http://blog.csdn.net/luoshengyang/article/details/6768304" target="_blank" rel="external">Android系统进程Zygote启动过程的源代码分析</a></p>
<p><a href="http://www.cnblogs.com/innost/archive/2011/01/26/1945769.html" target="_blank" rel="external">Android深入浅出之Zygote</a></p>
<h2 id="5-4-Zygote的Socket安全检查"><a href="#5-4-Zygote的Socket安全检查" class="headerlink" title="5.4 Zygote的Socket安全检查"></a>5.4 Zygote的Socket安全检查</h2><p><a href="">空</a></p>
<h1 id="6-Android中的ContentProvider以及基于URI的安全"><a href="#6-Android中的ContentProvider以及基于URI的安全" class="headerlink" title="6.Android中的ContentProvider以及基于URI的安全"></a>6.Android中的ContentProvider以及基于URI的安全</h1><h2 id="6-1-ContentProvider的作用"><a href="#6-1-ContentProvider的作用" class="headerlink" title="6.1.ContentProvider的作用"></a>6.1.ContentProvider的作用</h2><h3 id="6-1-1-软件设计更优美-官方"><a href="#6-1-1-软件设计更优美-官方" class="headerlink" title="6.1.1.软件设计更优美(官方)"></a>6.1.1.软件设计更优美(官方)</h3><pre><code>屏蔽内部数据存储操作的差异性
对外提供一致的数据操作方式
抽象/共性----&gt;都是数据操作
</code></pre><h3 id="6-1-2-进程间数据共享"><a href="#6-1-2-进程间数据共享" class="headerlink" title="6.1.2.进程间数据共享"></a>6.1.2.进程间数据共享</h3><pre><code>       Proxy|        Binder              |  Content Provider
client Process  ------------------------------- &gt; Service Process 
</code></pre><h2 id="6-2-权限临时继承的需求"><a href="#6-2-权限临时继承的需求" class="headerlink" title="6.2.权限临时继承的需求"></a>6.2.权限临时继承的需求</h2><pre><code>临时委派使得委托者的权限临时提升(类似Root-setUID模式)
</code></pre><h2 id="6-3-配置ContentProvider允许临时委派权限"><a href="#6-3-配置ContentProvider允许临时委派权限" class="headerlink" title="6.3.配置ContentProvider允许临时委派权限"></a>6.3.配置ContentProvider允许临时委派权限</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span> </span><br><span class="line">	<span class="attr">android:readPermission</span>=<span class="string">"com.tu.test.diyPermission.DIYPERMISSION_CONTENTPROVIDER_READ"</span></span><br><span class="line">	<span class="attr">android:grantUriPermissions</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--允许派遣给uri--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">provider</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">		....</span><br><span class="line">		<span class="tag">&lt;<span class="name">grant-uri-permission</span> <span class="attr">android:path</span>=<span class="string">"/comtu/"</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--允许派遣给限制URI的路径--&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">provider</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">		....</span><br><span class="line">		<span class="tag">&lt;<span class="name">grant-uri-permission</span> <span class="attr">android:pathPrefix</span>=<span class="string">"/abc/"</span>/&gt;</span></span><br><span class="line">				<span class="comment">&lt;!--允许派遣给限制URI的路径前缀--&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">provider</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">		....</span><br><span class="line">		<span class="tag">&lt;<span class="name">grant-uri-permission</span> <span class="attr">android:pathPattern</span>=<span class="string">".*public.*"</span>/&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--允许派遣给限制URI的路径通过正则--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="6-4-基于URI的权限临时委派"><a href="#6-4-基于URI的权限临时委派" class="headerlink" title="6.4.基于URI的权限临时委派"></a>6.4.基于URI的权限临时委派</h2><h3 id="6-4-1-基于API"><a href="#6-4-1-基于API" class="headerlink" title="6.4.1 基于API"></a>6.4.1 基于API</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//委派uri权限临时委派给com.example.testapps.test2,权限为FLAG_GRANT_READ_URI_PERMISSION</span></span><br><span class="line">uri = <span class="string">"content://com.example.testapps.test1.mailprovider/attachments/42"</span>;</span><br><span class="line">Context.grantUriPermission(<span class="string">"com.example.testapps.test2"</span>,uri,Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line"><span class="comment">//一定时间之后将收回委派的权限.否则可能存在安全隐患.需要思考的时什么时候收回.</span></span><br><span class="line">uri = <span class="string">"content://com.example.testapps.test1.mailprovider/attachments/42"</span>;</span><br><span class="line">Context.revokeUriPermission(uri,Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br></pre></td></tr></table></figure>
<h3 id="6-4-2-基于Intent"><a href="#6-4-2-基于Intent" class="headerlink" title="6.4.2 基于Intent"></a>6.4.2 基于Intent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);</span><br><span class="line">intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">intent.setDataAndType(uri,<span class="string">"image/gif"</span>);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<pre><code>权限的生命周期: Activity Start --&gt; Destro即Activity的生命周期
</code></pre><h1 id="7-Android的Policy模式和多设备绑定"><a href="#7-Android的Policy模式和多设备绑定" class="headerlink" title="7.Android的Policy模式和多设备绑定"></a>7.Android的Policy模式和多设备绑定</h1><h2 id="7-1-Android的Policy模式"><a href="#7-1-Android的Policy模式" class="headerlink" title="7.1.Android的Policy模式"></a>7.1.Android的Policy模式</h2><pre><code>一个移动平台它解决用户隐私,相当的一系列控制或者说是跟用户的交互模式.
安装时安全提问
    列出所有权限,提示用户是否安装.

    All or Nothing 
    None Runtime Control 
    None Recallable 
    Disable untrust source by default 
</code></pre><h2 id="7-2-MR2开始的AppOps-安卓4-3开始"><a href="#7-2-MR2开始的AppOps-安卓4-3开始" class="headerlink" title="7.2.MR2开始的AppOps(安卓4.3开始)"></a>7.2.MR2开始的AppOps(安卓4.3开始)</h2><pre><code>如 LBE 等安全卫士控制权限

&gt;基于AppOps Service
&gt;定义Ignore , Allow Reject 3种Policy
&gt;Hook and check Permission
</code></pre><h2 id="7-3AppOps对开发者的影响"><a href="#7-3AppOps对开发者的影响" class="headerlink" title="7.3AppOps对开发者的影响"></a>7.3AppOps对开发者的影响</h2><pre><code>开发者已经申请权限时,但被LBE等安全卫士等的权限限制.
    会导致权限一样获取不到.为了代码健壮性,需加多一些try catch.防止异常
</code></pre><h2 id="7-4设备绑定"><a href="#7-4设备绑定" class="headerlink" title="7.4设备绑定"></a>7.4设备绑定</h2><pre><code>应用与设备绑定的需求前景
    如,计费应用.

&gt;同时基于SIM卡和Device的绑定(如BREW下载,单机内的下载卡可用.基于SIM卡计费,运营商间排斥)
&gt;仅基于Device的绑定(如Google Store下载,当时下载的Device可用)
&gt;实现: 加密 per device per SIM卡
    Device Key: ESN/MEID/IMEI or random generate
    SIM ID : IMSI
</code></pre><h2 id="7-5跨设备使用"><a href="#7-5跨设备使用" class="headerlink" title="7.5跨设备使用"></a>7.5跨设备使用</h2><pre><code>基于Account ID的云端管理
Device1 --buy it using xx@x.x account --&gt;AppStore&lt;----Down load freely--(Register as xx@x.x) --Device2
</code></pre><h1 id="8-应用内计费和App2SDCard"><a href="#8-应用内计费和App2SDCard" class="headerlink" title="8.应用内计费和App2SDCard"></a>8.应用内计费和App2SDCard</h1><h2 id="8-1-应用内计费"><a href="#8-1-应用内计费" class="headerlink" title="8.1 应用内计费"></a>8.1 应用内计费</h2><pre><code>什么是应用内计费
    In App purchase or In app Billing(IAP,IAB)
    直接在应用内进行Paymen以unLock某些功能,或者买某些道具等
应用内计费的需求
    可支付途径(信用卡,手机卡等)
    安全性:
        面向用户
            可知
            可控
        面向应用
            可信(避免免费使用收费内容)

解决方案
    &gt;计费Server接口保密且Transiction加密(SSL)
    &gt;仅允许配套的安全本地组件与计费Server通信,且安全本地组件负责
        与用户的&quot;显式&quot;交互,同时提供API给Client
    &gt;Clent仅允许调用本地计费安全组件来委派Transiction
    &gt;Response的signature + Nounce (防止重放攻击)
</code></pre><h2 id="8-2-SD卡安装应用的安全策略"><a href="#8-2-SD卡安装应用的安全策略" class="headerlink" title="8.2 SD卡安装应用的安全策略"></a>8.2 SD卡安装应用的安全策略</h2><pre><code>绑定设备
    &gt;绑定perDevice使得防Export:应用以及应用数据(SD卡允许Export)
    &gt;以加密实现之:例子,应用安装至SD卡(.Android_Secure in SDCard)

ASEC的不可访问性
    由于.Android_Secure的加密特性,所以需要禁止应用直接Access该Folder(允许Access SDCard上的其他任何内容)
</code></pre><h1 id="9-Android中的多用户安全"><a href="#9-Android中的多用户安全" class="headerlink" title="9.Android中的多用户安全"></a>9.Android中的多用户安全</h1><pre><code>4.2开始可以支持
</code></pre><h2 id="9-1需求场景"><a href="#9-1需求场景" class="headerlink" title="9.1需求场景"></a>9.1需求场景</h2><pre><code>已有的例子/ Windows/Linux多用户

Android中的差别
    UID/GID跟着User走
    UID/GID和User的区分和绑定
应用的可控共享
    共享,不存在多份Code
    可控,控制谁可见.
数据的多用户独立
    工作目录
    External Storage(外部存储器)
</code></pre><h2 id="9-2UserManagerService"><a href="#9-2UserManagerService" class="headerlink" title="9.2UserManagerService"></a>9.2UserManagerService</h2><pre><code>作用:
    管理User的属性信息: 设置/获取用户的UserId,Name,Icon,RestrictProfile等
    管理User:创建,删除等

UserId(UserHandle)是Process的属性,不100%等同于当前设置切换的用户
一切与多用户相关的运行时行为(比如Mount的SDCard等)与进程的UserID所属有关,
    而与当前设置中的当前用户没有必然联系
典型的例子:
    通过adb shell的方式,永远只能访问User0的SDCard:/data/media/0,不管切换哪个用户
    通过文件管理器应用访问的SDCard则与当前用户相关.
    原因: adb shell只存在User0,不管在哪个当前设置用户下.
</code></pre><h2 id="9-3对开发者的影响"><a href="#9-3对开发者的影响" class="headerlink" title="9.3对开发者的影响"></a>9.3对开发者的影响</h2><pre><code>永远使用相对路径(基于工作目录)以及基于Environment.getXXXX来获取你感兴趣的路径(Environment内部
    会处理多用户).否则会出现路径错误而访问被拒绝的问题.
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">New <span class="title">File</span><span class="params">(<span class="string">"setting/setting.log"</span>)</span></span>;</span><br><span class="line"><span class="function">New <span class="title">File</span><span class="params">(Environment.getExternalStorageDirectory+<span class="string">"SharePic/a.png"</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<h1 id="10-Android-Superuser机制讲解"><a href="#10-Android-Superuser机制讲解" class="headerlink" title="10.Android Superuser机制讲解"></a>10.Android Superuser机制讲解</h1><h2 id="10-1-ROOT的作用"><a href="#10-1-ROOT的作用" class="headerlink" title="10.1 ROOT的作用"></a>10.1 ROOT的作用</h2><pre><code>Customization(定制,用户化)
任何需要特权的操作
</code></pre><h2 id="10-2-ROOT的第一步-寻找漏洞并安装特权文件"><a href="#10-2-ROOT的第一步-寻找漏洞并安装特权文件" class="headerlink" title="10.2 ROOT的第一步:寻找漏洞并安装特权文件"></a>10.2 ROOT的第一步:寻找漏洞并安装特权文件</h2><pre><code>Hack会寻找漏洞,如UID设置设备(ADB)
手机Root后,最重要的是,给手机安装了su程序和superuser apk. su一般被安装在/system/xbin或者/system/bin
</code></pre><h2 id="10-3-SU的sUID的特性"><a href="#10-3-SU的sUID的特性" class="headerlink" title="10.3 SU的sUID的特性"></a>10.3 SU的sUID的特性</h2><pre><code>Android的App授权获取Root权限,其实不是App自身的权限提升了,而是通过具有Root权限的Sh流来执行shell命令.
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell@android:/system/xbin # ls su -l</span><br><span class="line">ls su -l</span><br><span class="line">-rwsr-sr-x root     root        79500 2008-08-01 20:00 su</span><br></pre></td></tr></table></figure>
<pre><code>这里可以看到,su是Owner和Group分别为Root,Root.Other用户具有Execute权限,另外,su设置了suid和sgid,这个非常重要,
    使得Su进程可以提升自身的EUID.
</code></pre><h2 id="10-4-SU的核心代码分析"><a href="#10-4-SU的核心代码分析" class="headerlink" title="10.4 SU的核心代码分析"></a>10.4 SU的核心代码分析</h2><pre><code>在JB MR2(4.3)之前,Apk内部可以通过Java的Runtime执行一个
    具有Root-setUid的可执行文件而提升Effective UID来完成一些特权操作,典型的Root包中的su就是这个原理.
JB MR2中,修补了改漏洞.
</code></pre><h2 id="10-5-MR2后的方案-SU-Deamon-Service"><a href="#10-5-MR2后的方案-SU-Deamon-Service" class="headerlink" title="10.5 MR2后的方案:SU Deamon Service"></a>10.5 MR2后的方案:SU Deamon Service</h2><pre><code>怎么办? Native Service依然可以利用Root-setUID的su提升权限
</code></pre><h1 id="11-SEAndroid"><a href="#11-SEAndroid" class="headerlink" title="11.SEAndroid"></a>11.SEAndroid</h1><h2 id="11-1-DAC和MAC"><a href="#11-1-DAC和MAC" class="headerlink" title="11.1 DAC和MAC"></a>11.1 DAC和MAC</h2><pre><code>DAC
    自主访问控制
    主体(Process)的Capability觉得了它能访问和操作什么?
        Root进程可以访问和操作一切!
    传统(legacy)Linux的安全模式,基于UID/GID/Capability
MAC 
    强制访问控制
    系统的Policy觉得了主体能操作访问哪些客体
    即便是ROOT进程,系统Policy配置了你能做什么,你只能做什么,在MAC模式下,ROOT进程和普通进程是无区别对待的.
</code></pre><h2 id="11-2-基于Label的MAC"><a href="#11-2-基于Label的MAC" class="headerlink" title="11.2 基于Label的MAC"></a>11.2 基于Label的MAC</h2><pre><code>每个主体/客体在运行时都绑定一个标签(Label)
该标签又称为Security Context
Security Context的构成
    User : Role : Type : SecurityLevel
    比如: u:r:zygote:s0
Type Enhancement
    Security Context中的Type主要是用于Policy的设定,即Policy
    一般的Rule是:
        Allow Type Type : Operation
        Allow appdomain zygote_tmpfs:file read;
    所以,Type被实际用于&quot;授权&quot;的Decision,所以称之为Type Enhancement
ls命令的SELinux版本: ls -l -Z

Ps命令的SELinux版本: ps -Z
</code></pre><h2 id="11-3-推荐读物"><a href="#11-3-推荐读物" class="headerlink" title="11.3 推荐读物"></a>11.3 推荐读物</h2><p><a href="http://opensource.com/business/13/11/selinux-policy-guide" target="_blank" rel="external">Your visual how-to guide for SELinux policy enforcement</a></p>
<p><a href="http://book.51cto.com/art/200810/94193.htm" target="_blank" rel="external">SELinux实例：使用安全增强的Linux</a></p>
<hr>
<h1 id="Demo下载"><a href="#Demo下载" class="headerlink" title="Demo下载"></a>Demo下载</h1><p>Android中的组件的安全机制之组件的权限分配(Demo)<br>Activity Service ContentProvide BroadcastReceiver四大组件不同App数据通信:<br><a href="/res/file/blog/2014/10/27/android_safe_mode_mechanism_three/Permission.rar">Demo</a></p>

      
    </div>
    
    <div>
      
        
      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android安全模式机制/" rel="tag">#Android安全模式机制</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2014/10/26/android_safe_mode_mechanism_two.html" rel="next" title="Android安全模式机制之二(操作系统现代安全体系基础概念)">
                <i class="fa fa-chevron-left"></i> Android安全模式机制之二(操作系统现代安全体系基础概念)
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2014/10/28/Android_NDK_IDE_environment_one.html" rel="prev" title="Android 中NDK的使用详解第一篇:环境">
                Android 中NDK的使用详解第一篇:环境 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="/2014/10/27/android_safe_mode_mechanism_three.html"
           data-title="Android安全模式机制之三(实际运用)" data-url="http://comtu.github.com/2014/10/27/android_safe_mode_mechanism_three.html">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/icon.jpg"
               alt="Comtu" />
          <p class="site-author-name" itemprop="name">Comtu</p>
          <p class="site-description motion-element" itemprop="description">The time is passing</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">26</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">91</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-移动平台中的主流签名作用"><span class="nav-number">1.</span> <span class="nav-text">1.移动平台中的主流签名作用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-自签名的完整性鉴别"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 自签名的完整性鉴别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-信任模式"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 信任模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-限制安装-运行"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 限制安装/运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-权限的作用"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 权限的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-权限的安全性保护"><span class="nav-number">1.5.</span> <span class="nav-text">1.5 权限的安全性保护</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-Android的签名作用"><span class="nav-number">1.6.</span> <span class="nav-text">1.6 Android的签名作用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-1-完整性鉴别"><span class="nav-number">1.6.1.</span> <span class="nav-text">1.6.1.完整性鉴别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-2-Signature-Permision和ShareUID"><span class="nav-number">1.6.2.</span> <span class="nav-text">1.6.2.Signature Permision和ShareUID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-3-身份ID和升级的匹配"><span class="nav-number">1.6.3.</span> <span class="nav-text">1.6.3.身份ID和升级的匹配</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7Android-APK之METAINF"><span class="nav-number">1.7.</span> <span class="nav-text">1.7Android APK之METAINF</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Android中的权限"><span class="nav-number">2.</span> <span class="nav-text">2.Android中的权限</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Android的权限作用"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 Android的权限作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Android的权限类别"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Android的权限类别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-Android的权限定义方式"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 Android的权限定义方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-Android的运行时权限控制方式"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 Android的运行时权限控制方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-Android的Permission与UID-GID的mapping"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 Android的Permission与UID/GID的mapping</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Android中的组件的安全机制"><span class="nav-number">3.</span> <span class="nav-text">3.Android中的组件的安全机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-组件的权限分配-demo"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 组件的权限分配(demo)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-Activity"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1.Activity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-service"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2.service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-ContentProvide"><span class="nav-number">3.1.3.</span> <span class="nav-text">3.1.3.ContentProvide</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-4-BroadcastReceiver"><span class="nav-number">3.1.4.</span> <span class="nav-text">3.1.4.BroadcastReceiver</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-应用安装"><span class="nav-number">4.</span> <span class="nav-text">4.应用安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-应用安装的安全性考虑和调用方式"><span class="nav-number">4.1.</span> <span class="nav-text">4.1.应用安装的安全性考虑和调用方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-应用安装流程之UID-GID的分配"><span class="nav-number">4.2.</span> <span class="nav-text">4.2.应用安装流程之UID/GID的分配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-应用安装流程之工作目录的创建和权限设置"><span class="nav-number">4.3.</span> <span class="nav-text">4.3.应用安装流程之工作目录的创建和权限设置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-Android中系统Service的安全"><span class="nav-number">5.</span> <span class="nav-text">5.Android中系统Service的安全</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-Binder的安全"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 Binder的安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-ServiceManager-Add-Service的安全限制"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 ServiceManager Add Service的安全限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-Zygote的Process-Fork"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 Zygote的Process Fork</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-Zygote的Socket安全检查"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 Zygote的Socket安全检查</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-Android中的ContentProvider以及基于URI的安全"><span class="nav-number">6.</span> <span class="nav-text">6.Android中的ContentProvider以及基于URI的安全</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-ContentProvider的作用"><span class="nav-number">6.1.</span> <span class="nav-text">6.1.ContentProvider的作用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-1-软件设计更优美-官方"><span class="nav-number">6.1.1.</span> <span class="nav-text">6.1.1.软件设计更优美(官方)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-2-进程间数据共享"><span class="nav-number">6.1.2.</span> <span class="nav-text">6.1.2.进程间数据共享</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-权限临时继承的需求"><span class="nav-number">6.2.</span> <span class="nav-text">6.2.权限临时继承的需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-配置ContentProvider允许临时委派权限"><span class="nav-number">6.3.</span> <span class="nav-text">6.3.配置ContentProvider允许临时委派权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-基于URI的权限临时委派"><span class="nav-number">6.4.</span> <span class="nav-text">6.4.基于URI的权限临时委派</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-1-基于API"><span class="nav-number">6.4.1.</span> <span class="nav-text">6.4.1 基于API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-2-基于Intent"><span class="nav-number">6.4.2.</span> <span class="nav-text">6.4.2 基于Intent</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-Android的Policy模式和多设备绑定"><span class="nav-number">7.</span> <span class="nav-text">7.Android的Policy模式和多设备绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-Android的Policy模式"><span class="nav-number">7.1.</span> <span class="nav-text">7.1.Android的Policy模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-MR2开始的AppOps-安卓4-3开始"><span class="nav-number">7.2.</span> <span class="nav-text">7.2.MR2开始的AppOps(安卓4.3开始)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3AppOps对开发者的影响"><span class="nav-number">7.3.</span> <span class="nav-text">7.3AppOps对开发者的影响</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4设备绑定"><span class="nav-number">7.4.</span> <span class="nav-text">7.4设备绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5跨设备使用"><span class="nav-number">7.5.</span> <span class="nav-text">7.5跨设备使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-应用内计费和App2SDCard"><span class="nav-number">8.</span> <span class="nav-text">8.应用内计费和App2SDCard</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-应用内计费"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 应用内计费</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-SD卡安装应用的安全策略"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 SD卡安装应用的安全策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-Android中的多用户安全"><span class="nav-number">9.</span> <span class="nav-text">9.Android中的多用户安全</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1需求场景"><span class="nav-number">9.1.</span> <span class="nav-text">9.1需求场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2UserManagerService"><span class="nav-number">9.2.</span> <span class="nav-text">9.2UserManagerService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3对开发者的影响"><span class="nav-number">9.3.</span> <span class="nav-text">9.3对开发者的影响</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-Android-Superuser机制讲解"><span class="nav-number">10.</span> <span class="nav-text">10.Android Superuser机制讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-ROOT的作用"><span class="nav-number">10.1.</span> <span class="nav-text">10.1 ROOT的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-ROOT的第一步-寻找漏洞并安装特权文件"><span class="nav-number">10.2.</span> <span class="nav-text">10.2 ROOT的第一步:寻找漏洞并安装特权文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-SU的sUID的特性"><span class="nav-number">10.3.</span> <span class="nav-text">10.3 SU的sUID的特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-SU的核心代码分析"><span class="nav-number">10.4.</span> <span class="nav-text">10.4 SU的核心代码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-MR2后的方案-SU-Deamon-Service"><span class="nav-number">10.5.</span> <span class="nav-text">10.5 MR2后的方案:SU Deamon Service</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-SEAndroid"><span class="nav-number">11.</span> <span class="nav-text">11.SEAndroid</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-DAC和MAC"><span class="nav-number">11.1.</span> <span class="nav-text">11.1 DAC和MAC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-基于Label的MAC"><span class="nav-number">11.2.</span> <span class="nav-text">11.2 基于Label的MAC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-推荐读物"><span class="nav-number">11.3.</span> <span class="nav-text">11.3 推荐读物</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Demo下载"><span class="nav-number">12.</span> <span class="nav-text">Demo下载</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Comtu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"comtu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  





  
  
  

  

  

</body>
</html>
